#!/usr/bin/env bash
# Pre-push hook for comprehensive quality checks
# Runs more expensive checks before pushing to remote

set -e

echo "ğŸš€ Running pre-push checks..."

# Determine changed files and packages
CHANGED_PACKAGES=$(git diff origin/main..HEAD --name-only | grep -E '^(packages|apps)/' | cut -d'/' -f1-2 | sort -u || true)
CHANGED_FILES=$(git diff origin/main..HEAD --name-only || true)

echo "  ğŸ“‹ Changed packages: ${CHANGED_PACKAGES:-none}"
echo "  ğŸ“„ Changed files: $(echo "$CHANGED_FILES" | wc -l) files"

# 1. Type check changed packages
if [ -n "$CHANGED_PACKAGES" ]; then
  echo "  ğŸ” Type checking changed packages..."
  for PKG in $CHANGED_PACKAGES; do
    if [ -f "$PKG/package.json" ]; then
      PKG_NAME=$(node -p "require('./$PKG/package.json').name || ''")
      if [ -n "$PKG_NAME" ]; then
        echo "    âœ“ Type checking $PKG_NAME..."
        pnpm --filter="$PKG_NAME" run type-check || {
          echo "    âŒ Type check failed for $PKG_NAME"
          exit 1
        }
      fi
    fi
  done
else
  echo "  ğŸ” No packages changed - skipping type check"
fi

# 2. Lint changed packages
if [ -n "$CHANGED_PACKAGES" ]; then
  echo "  ğŸ“ Linting changed packages..."
  for PKG in $CHANGED_PACKAGES; do
    if [ -f "$PKG/package.json" ]; then
      PKG_NAME=$(node -p "require('./$PKG/package.json').name || ''")
      if [ -n "$PKG_NAME" ]; then
        echo "    âœ“ Linting $PKG_NAME..."
        pnpm --filter="$PKG_NAME" run lint:canary || {
          echo "    âŒ Lint failed for $PKG_NAME"
          exit 1
        }
      fi
    fi
  done
else
  echo "  ğŸ“ No packages changed - skipping lint"
fi

# 3. Test changed packages
if [ -n "$CHANGED_PACKAGES" ]; then
  echo "  ğŸ§ª Testing changed packages..."
  for PKG in $CHANGED_PACKAGES; do
    if [ -f "$PKG/package.json" ]; then
      PKG_NAME=$(node -p "require('./$PKG/package.json').name || ''")
      if [ -n "$PKG_NAME" ]; then
        echo "    âœ“ Testing $PKG_NAME..."
        pnpm --filter="$PKG_NAME" run test || {
          echo "    âŒ Tests failed for $PKG_NAME"
          exit 1
        }
      fi
    fi
  done
else
  echo "  ğŸ§ª No packages changed - skipping tests"
fi

# 4. Placeholder for architecture validation
echo "  ğŸ›ï¸  Architecture validation..."
echo "    (placeholder - not implemented yet)"

# 5. Placeholder for infra verification
echo "  ğŸ§± Infrastructure verification..."
echo "    (placeholder - not implemented yet)"

# 5. Check for security issues (optional)
# echo "  ğŸ”’ Checking for security issues..."
# pnpm run security:audit || {
#   echo "  âš ï¸  Security issues found (continuing)"
# }

echo "âœ… Pre-push checks passed!"

