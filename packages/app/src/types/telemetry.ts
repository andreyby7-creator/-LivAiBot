/**
 * @file packages/app/src/types/telemetry.ts
 * ============================================================================
 * üß± –û–ë–©–ò–ï –¢–ò–ü–´ –¢–ï–õ–ï–ú–ï–¢–†–ò–ò
 * ============================================================================
 *
 * –°–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–∞–∫ core,
 * —Ç–∞–∫ –∏ –ø—É–±–ª–∏—á–Ω—ã–º API. –†–∞–∑–¥–µ–ª–µ–Ω—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
 */

/* ============================================================================
 * üè∑Ô∏è –û–°–ù–û–í–ù–´–ï –¢–ò–ü–´ –£–†–û–í–ù–ï–ô
 * ========================================================================== */

/** –£—Ä–æ–≤–Ω–∏ –≤–∞–∂–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π */
export const TelemetryLevels = ['INFO', 'WARN', 'ERROR'] as const;

/** –¢–∏–ø —É—Ä–æ–≤–Ω—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–±—ã—Ç–∏—è */
export type TelemetryLevel = (typeof TelemetryLevels)[number];

/* ============================================================================
 * üìä –¢–ò–ü–´ –°–û–ë–´–¢–ò–ô
 * ========================================================================== */

/** –ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ */
type TelemetryPrimitive = string | number | boolean | null;

/** –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ */
export type TelemetryMetadata = Readonly<Record<string, TelemetryPrimitive>>;

/**
 * –¢–µ–ª–µ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ - –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.
 * –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
 */
export type TelemetryEvent<
  TMetadata = TelemetryMetadata,
> = Readonly<{
  /** –£—Ä–æ–≤–µ–Ω—å –≤–∞–∂–Ω–æ—Å—Ç–∏ —Å–æ–±—ã—Ç–∏—è */
  readonly level: TelemetryLevel;
  /** –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è */
  readonly message: string;
  /** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ */
  readonly metadata?: TMetadata;
  /** –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è */
  readonly timestamp: number;
}>;

/* ============================================================================
 * üîß –¢–ò–ü–´ BATCH CORE
 * ========================================================================== */

/**
 * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ–≥–æ batch —è–¥—Ä–∞.
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ —á–∏—Å—Ç–æ–π batch –æ–±—Ä–∞–±–æ—Ç–∫–∏.
 */
export type TelemetryBatchCoreConfig = Readonly<{
  /** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä batch –ø–µ—Ä–µ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º flush */
  readonly maxBatchSize: number;
  /** –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ */
  readonly configVersion: number;
}>;

/**
 * –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ–≥–æ batch —è–¥—Ä–∞.
 * –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.
 */
export type TelemetryBatchCoreState<
  TMetadata = TelemetryMetadata,
> = {
  /** –ò–º–º—É—Ç–∞–±–µ–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ —Å–æ–±—ã—Ç–∏–π –≤ batch (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ) */
  readonly batch: readonly TelemetryEvent<TMetadata>[];
  /** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —è–¥—Ä–∞ */
  readonly config: TelemetryBatchCoreConfig;
};

/* ============================================================================
 * ‚öôÔ∏è –ö–û–ù–°–¢–ê–ù–¢–´
 * ========================================================================== */

/** –í–µ—Ä—Å–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ batch core –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π */
export const BatchCoreConfigVersion = 1;

/* ============================================================================
 * üîå –¢–ò–ü–´ SINK
 * ========================================================================== */

/**
 * Sink - –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π (console, –≤–Ω–µ—à–Ω–∏–µ SDK –∏ —Ç.–¥.)
 */
export type TelemetrySink<TMetadata = TelemetryMetadata> = (
  event: TelemetryEvent<TMetadata>,
) => void | Promise<void>;

/**
 * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ - –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
 */
export type TelemetryConfig<
  TMetadata = TelemetryMetadata,
> = Readonly<{
  levelThreshold?: TelemetryLevel; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
  sinks?: readonly TelemetrySink<TMetadata>[]; // –ú–∞—Å—Å–∏–≤ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏–π
  onError?: (error: unknown, event: TelemetryEvent<TMetadata>) => void; // Callback –¥–ª—è –æ—à–∏–±–æ–∫ sinks
}>;
