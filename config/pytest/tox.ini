[tox]
envlist = py312,py313
skip_missing_interpreters = true
isolated_build = true

[testenv]
# Базовое окружение для тестирования
deps =
    -r requirements-dev.txt
    pytest
    pytest-cov
    pytest-asyncio
    pytest-mock
    pytest-xdist
    coverage[toml]

# Команды для запуска тестов
commands =
    pytest {posargs}

# Переменные окружения
setenv =
    PYTHONPATH = {toxinidir}
    PYTHONDONTWRITEBYTECODE = 1

# Использовать локальную версию пакета без установки
usedevelop = true

[testenv:coverage]
# Специальное окружение для отчетов покрытия
deps =
    {[testenv]deps}
    coverage[toml]

commands =
    coverage run --source=services -m pytest {posargs}
    coverage report
    coverage html -d reports/coverage/python
    coverage json -o reports/coverage/python.json

[testenv:lint]
# Окружение для линтинга
deps =
    -r requirements-dev.txt
    flake8
    black
    isort
    mypy

commands =
    flake8 --max-line-length=120 services/
    black --check services/
    isort --check-only services/
    mypy --strict services/

[testenv:ci]
# Окружение для CI (быстрое выполнение без тяжелых тестов)
deps = {[testenv]deps}

commands =
    pytest -m "not (slow or ai or e2e)" --maxfail=5 --tb=short --strict-markers {posargs}

setenv =
    {[testenv]setenv}
    CI = true