/**
 * @file –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Vitest
 *
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è LivAI.
 * –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∑–∞—â–∏—Ç–∞ –æ—Ç –æ–ø–µ—á–∞—Ç–æ–∫.
 */

type EnvRecord = Record<TestEnvKeys, string>;
type EnvOverrides = Partial<Record<TestEnvKeys, string>>;

// =============================================================================
// ENUM
// =============================================================================

/** –ö–ª—é—á–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤ */
export enum TestEnvKeys {
  NODE_ENV = 'NODE_ENV',
  DATABASE_URL = 'DATABASE_URL',
  REDIS_URL = 'REDIS_URL',
  JWT_SECRET = 'JWT_SECRET',
  OPENAI_API_KEY = 'OPENAI_API_KEY',
  ANTHROPIC_API_KEY = 'ANTHROPIC_API_KEY',
  GOOGLE_AI_API_KEY = 'GOOGLE_AI_API_KEY',
  GROK_API_KEY = 'GROK_API_KEY',
  DEEPSEEK_API_KEY = 'DEEPSEEK_API_KEY',
  QWEN_API_KEY = 'QWEN_API_KEY',
  YANDEX_API_KEY = 'YANDEX_API_KEY',
  GIGACHAT_API_KEY = 'GIGACHAT_API_KEY',
  LLAMA_API_KEY = 'LLAMA_API_KEY',
  SENTRY_DSN = 'SENTRY_DSN',
  POSTHOG_API_KEY = 'POSTHOG_API_KEY',
  API_BASE_URL = 'API_BASE_URL',
  WEB_BASE_URL = 'WEB_BASE_URL',
}

// =============================================================================
// –ö–û–ù–°–¢–ê–ù–¢–´
// =============================================================================

/**
 * –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤.
 *
 * –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –†–ï–®–ï–ù–ò–ï: –°–¢–†–û–ì–ê–Ø –ò–ó–û–õ–Ø–¶–ò–Ø
 * ========================================
 *
 * –¢–æ–ª—å–∫–æ JWT_SECRET –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç–µ—Å—Ç–æ–≤.
 * –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ API (OpenAI, Anthropic, etc.) –¥–æ–ª–∂–Ω—ã –º–æ–∫–∞—é—Ç—Å—è –≤ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–∞—Ö.
 *
 * –ü–æ—á–µ–º—É —Ç–æ–ª—å–∫–æ JWT_SECRET?
 * - –ù—É–∂–µ–Ω –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏/–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
 * - –î—Ä—É–≥–∏–µ API –∫–ª—é—á–∏ –∏–º–µ—é—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –º–æ–∫–æ–≤
 * - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–π, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π CI/CD –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
 *
 * –î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö AI —Ç–µ—Å—Ç–æ–≤ ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—å—é—Ç (pnpm test:ai)
 * –î–ª—è E2E —Ç–µ—Å—Ç–æ–≤ ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—å—é—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
 */
const REQUIRED_TEST_ENV_KEYS: readonly TestEnvKeys[] = [
  TestEnvKeys.JWT_SECRET, // –¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç—ã, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
];

// =============================================================================
// –î–ï–§–û–õ–¢–ù–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø –û–ö–†–£–ñ–ï–ù–ò–Ø
// =============================================================================

/**
 * –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤.
 * –°–æ–∑–¥–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
 *
 * –í–°–ï –í–ù–ï–®–ù–ò–ï API –ö–õ–Æ–ß–ò –ò–ú–ï–Æ–¢ –¢–ï–°–¢–û–í–´–ï –ó–ê–ì–õ–£–®–ö–ò –î–õ–Ø –ú–û–ö–û–í:
 * ============================================================
 *
 * - OpenAI, Anthropic, Google AI –∫–ª—é—á–∏ ‚Üí –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –º–æ–∫–∞—Ö
 * - Sentry, PostHog –∫–ª—é—á–∏ ‚Üí —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
 * - Database/Redis URL ‚Üí —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 *
 * –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
 * ‚úÖ –ü–æ–ª–Ω—É—é –∏–∑–æ–ª—è—Ü–∏—é —Ç–µ—Å—Ç–æ–≤ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
 * ‚úÖ –ë—ã—Å—Ç—Ä—ã–π CI/CD –±–µ–∑ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–¥–µ—Ä–∂–µ–∫
 * ‚úÖ 100% –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∏/—Ç–∞–π–º–∞—É—Ç—ã)
 * ‚úÖ –≠–∫–æ–Ω–æ–º–∏—é API –ª–∏–º–∏—Ç–æ–≤ –∏ –±—é–¥–∂–µ—Ç–∞
 */
const DEFAULT_TEST_ENV: Readonly<EnvRecord> = Object.freeze({
  // –í—Å–µ–≥–¥–∞ test –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è Vitest
  [TestEnvKeys.NODE_ENV]: 'test',

  // –¢–µ—Å—Ç–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å)
  [TestEnvKeys.DATABASE_URL]: 'postgres://test:test@localhost:5432/livai_test',
  [TestEnvKeys.REDIS_URL]: 'redis://localhost:6379',

  // –°–µ–∫—Ä–µ—Ç—ã (–≤—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
  [TestEnvKeys.JWT_SECRET]: 'test-jwt-secret-key-for-testing-only',

  // –í–ù–ï–®–ù–ò–ï API –ö–õ–Æ–ß–ò ‚Üí –¢–û–õ–¨–ö–û –î–õ–Ø –ú–û–ö–û–í (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ)
  [TestEnvKeys.OPENAI_API_KEY]: 'test-openai-key',
  [TestEnvKeys.ANTHROPIC_API_KEY]: 'test-anthropic-key',
  [TestEnvKeys.GOOGLE_AI_API_KEY]: 'test-google-ai-key',
  [TestEnvKeys.GROK_API_KEY]: 'test-grok-key',
  [TestEnvKeys.DEEPSEEK_API_KEY]: 'test-deepseek-key',
  [TestEnvKeys.QWEN_API_KEY]: 'test-qwen-key',
  [TestEnvKeys.YANDEX_API_KEY]: 'test-yandex-key',
  [TestEnvKeys.GIGACHAT_API_KEY]: 'test-gigachat-key',
  [TestEnvKeys.LLAMA_API_KEY]: 'test-llama-key',
  [TestEnvKeys.SENTRY_DSN]: 'test-sentry-dsn',
  [TestEnvKeys.POSTHOG_API_KEY]: 'test-posthog-key',

  // URLs –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
  [TestEnvKeys.API_BASE_URL]: 'http://localhost:3001',
  [TestEnvKeys.WEB_BASE_URL]: 'http://localhost:3000',
});

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π –∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.
 *
 * @returns EnvRecord - –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
 */
function getDefaultTestEnv(): Readonly<EnvRecord> {
  return DEFAULT_TEST_ENV;
}

// =============================================================================
// –í–ê–õ–ò–î–ê–¶–ò–Ø URL
// =============================================================================

/**
 * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç URL –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É.
 *
 * @param url - URL –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
 * @param key - –ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
 * @param pattern - –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
 * @param expectedFormat - –û–ø–∏—Å–∞–Ω–∏–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
 * @param exampleUrl - –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ URL –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
 * @throws Error –µ—Å–ª–∏ URL –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É
 */
function validateUrl(
  url: string,
  key: string,
  pattern: RegExp,
  expectedFormat: string,
  exampleUrl: string,
): void {
  if (url && !pattern.test(url)) {
    throw new Error(
      `${key} –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º URL (${expectedFormat}).\n`
        + `–ü—Ä–∏–º–µ—Ä: ${exampleUrl}\n`
        + `–ü–æ–ª—É—á–µ–Ω–æ: ${url}`,
    );
  }
}

/**
 * –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è API –∏ WEB URL —Å —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–º–∏—Å—è –æ—à–∏–±–∫–∞–º–∏.
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–æ–≤ –¥–ª—è localhost.
 * URL —Å –∫–æ–Ω–µ—á–Ω—ã–º —Å–ª–µ—à–µ–º —Å—á–∏—Ç–∞—é—Ç—Å—è –¥–æ–ø—É—Å—Ç–∏–º—ã–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, http://localhost:3000/).
 *
 * @param url - URL –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
 * @param key - –ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
 */
function validateApiWebUrl(url: string, key: string): void {
  if (!url) return;

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –ø—Ä–æ–±–µ–ª—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã
  if (/[\s<>'"\[\]{}|\\^`]/u.test(url)) {
    throw new Error(
      `${key} —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã (–ø—Ä–æ–±–µ–ª—ã, < > ' " [ ] { } | \\ ^ \`). –≠—Ç–∏ —Å–∏–º–≤–æ–ª—ã –º–æ–≥—É—Ç –ª–æ–º–∞—Ç—å URL.\n`
        + `–ü—Ä–∏–º–µ—Ä: http://localhost:3000\n`
        + `–ü–æ–ª—É—á–µ–Ω–æ: "${url}"`,
    );
  }

  // –î–ª—è localhost URL –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç
  if (url.includes('localhost')) {
    const portMatch = url.match(/:(\d+)/);
    if (portMatch && portMatch[1]) {
      const port = parseInt(portMatch[1], 10);
      if (port < 1 || port > 65535) {
        throw new Error(
          `${key} —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –ø–æ—Ä—Ç ${port}. –ü–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 65535.\n`
            + `–ü—Ä–∏–º–µ—Ä: http://localhost:3000\n`
            + `–ü–æ–ª—É—á–µ–Ω–æ: "${url}"`,
        );
      }
    }
  }

  // URL —Å –∫–æ–Ω–µ—á–Ω—ã–º —Å–ª–µ—à–µ–º –≤–ø–æ–ª–Ω–µ –¥–æ–ø—É—Å—Ç–∏–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, http://localhost:3000/)
  // –ù–µ —Ç—Ä–µ–±—É–µ–º —Å—Ç—Ä–æ–≥–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
}

// =============================================================================
// –í–ê–õ–ò–î–ê–¶–ò–Ø –û–ö–†–£–ñ–ï–ù–ò–Ø
// =============================================================================

/**
 * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤.
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏ –Ω–µ–ø—É—Å—Ç–æ—Ç—É –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π, –∞ —Ç–∞–∫–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤.
 *
 * @param env - –û–±—ä–µ–∫—Ç —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
 * @throws Error –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –æ–Ω–∏ –ø—É—Å—Ç—ã–µ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
 */
function validateTestEnv(env: EnvRecord): void {
  const missingKeys = REQUIRED_TEST_ENV_KEYS.filter((key) => {
    const val = String(env[key] ?? '');
    return !val || val.trim() === '';
  });

  if (missingKeys.length > 0) {
    throw new Error(
      `–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤: ${missingKeys.join(', ')}\n`
        + '–£–∫–∞–∂–∏—Ç–µ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ overrides –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Ö –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏.\n'
        + '–ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –Ω–µ –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.',
    );
  }

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  validateUrl(
    String(env[TestEnvKeys.DATABASE_URL] ?? ''),
    'DATABASE_URL',
    /^postgres(ql)?:\/\/.+/,
    '–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å postgres:// –∏–ª–∏ postgresql://',
    'postgres://user:password@localhost:5432/database_name',
  );

  validateUrl(
    String(env[TestEnvKeys.REDIS_URL] ?? ''),
    'REDIS_URL',
    /^redis:\/\/.+/,
    '–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å redis://',
    'redis://localhost:6379',
  );

  const apiUrl = String(env[TestEnvKeys.API_BASE_URL] ?? '');
  validateUrl(
    apiUrl,
    'API_BASE_URL',
    /^https?:\/\/.+/,
    '–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å http:// –∏–ª–∏ https://',
    'http://localhost:3001',
  );
  validateApiWebUrl(apiUrl, 'API_BASE_URL');

  const webUrl = String(env[TestEnvKeys.WEB_BASE_URL] ?? '');
  validateUrl(
    webUrl,
    'WEB_BASE_URL',
    /^https?:\/\/.+/,
    '–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å http:// –∏–ª–∏ https://',
    'http://localhost:3000',
  );
  validateApiWebUrl(webUrl, 'WEB_BASE_URL');
}

// =============================================================================
// –ü–£–ë–õ–ò–ß–ù–´–ô API
// =============================================================================

/**
 * –°–æ–∑–¥–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Vitest —Å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏.
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º.
 *
 * @param overrides - –ß–∞—Å—Ç–∏—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
 * @returns EnvRecord - –§–∏–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
 */
export function buildVitestEnv(overrides: EnvOverrides = {}): Readonly<EnvRecord> {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –∫–ª—é—á–µ–π
  const allowedKeys = Object.values(TestEnvKeys).sort();
  const unknownKeys = Object.keys(overrides).filter(
    (key) => !allowedKeys.includes(key as TestEnvKeys),
  );

  if (unknownKeys.length > 0) {
    throw new Error(
      `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–ª—é—á–∏ –≤ overrides (–≤–æ–∑–º–æ–∂–Ω—ã–µ –æ–ø–µ—á–∞—Ç–∫–∏): ${unknownKeys.join(', ')}\n`
        + `–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏: ${allowedKeys.join(', ')}`,
    );
  }

  // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  const filteredOverrides: Partial<EnvRecord> = Object.fromEntries(
    Object.entries(overrides).filter(([_, value]) => value !== undefined),
  );

  // –°–æ–∑–¥–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏
  const env: EnvRecord = {
    ...getDefaultTestEnv(),
    ...filteredOverrides,
  };

  // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
  const totalKeys = Object.keys(env).length;
  const overriddenKeys = Object.keys(overrides).length;
  const defaultKeys = totalKeys - overriddenKeys;

  if (process.env.VITEST_ENV_DEBUG === 'true') {
    console.log(
      `üîß Building test environment: ${totalKeys} keys (${defaultKeys} defaults, ${overriddenKeys} overrides)`,
    );
  }

  // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª—é—á–∏
  validateTestEnv(env);

  if (process.env.VITEST_ENV_DEBUG === 'true') {
    console.log(`‚úÖ Test environment validated successfully`);
  }

  // –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º—É—Ç–∞—Ü–∏–π
  return Object.freeze(env);
}
