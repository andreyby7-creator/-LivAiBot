/**
 * @file –û–±—â–∏–π setup —Ñ–∞–π–ª –¥–ª—è –≤—Å–µ—Ö –ø–∞–∫–µ—Ç–æ–≤ LivAI
 *
 * –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞—â–∏—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
 * - –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Ö—É–∫–æ–≤
 * - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
 * - –ß–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
 * - –ù–ï –ª–µ—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤, –∞ –∑–∞—â–∏—Ç–∞ —Å—Ä–µ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
 */

/// <reference types="node" />
import { afterEach, vi } from 'vitest';

// ------------------ –¢–ò–ü–ò–ó–ê–¶–ò–Ø –ì–õ–û–ë–ê–õ–¨–ù–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–• -----------------------------

// –¢–∏–ø –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
interface GlobalTestState {
  mocks?: Record<string, unknown>;
  counters?: Record<string, number>;
  timestamps?: Record<string, number>;
  cache?: Map<string, unknown>;
}

declare global {
  var testState: GlobalTestState | undefined;
  var __testTimers: NodeJS.Timeout[] | undefined;
}

// ------------------ –ó–ê–©–ò–¢–ê –û–¢ –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø –ì–õ–û–ë–ê–õ–¨–ù–´–• –•–£–ö–û–í -----------------------------

/**
 * –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
 * –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ watch mode –∏ hot-reload —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
 */
((): void => {
  // IIFE –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ module scope

  // ------------------ –ó–ê–©–ò–¢–ê –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´ - –ù–ï –õ–ï–ß–ï–ù–ò–ï –¢–ï–°–¢–û–í -----------------------------

  /**
   * Unhandled rejections - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏ –≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ
   * –ù–ï –≥–ª—É—à–∏–º, –∞ –¥–∞–µ–º Vitest —Ä–µ—à–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π —Ç–µ—Å—Ç–∞
   * –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –Ω–æ –Ω–µ –≤–º–µ—à–∏–≤–∞–µ–º—Å—è –≤ –ª–æ–≥–∏–∫—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   */
  process.on('unhandledRejection', (reason) => {
    console.warn('üö® Unhandled rejection detected:', reason);

    // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–µ–∫ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
    if (reason instanceof Error && reason.stack != null) {
      console.warn('Stack trace:', reason.stack);
    }

    // –ù–ï –≥–ª—É—à–∏–º - –ø–æ–∑–≤–æ–ª—è–µ–º Vitest —Ä–µ—à–∏—Ç—å, —É–ø–∞–ª —Ç–µ—Å—Ç –∏–ª–∏ –Ω–µ—Ç
    // –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–≥, –∞ –Ω–µ "–æ–∂–∏–¥–∞–µ–º–∞—è" –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞
  });

  /**
   * Uncaught exceptions - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
   * –í CI: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã)
   * –í dev: –ª–æ–≥–∏—Ä—É–µ–º –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å –ø–æ–ª–Ω—ã–º –≤—ã–≤–æ–¥–æ–º)
   * –ù–∏–∫–∞–∫–∏—Ö "–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–π —Ä–∞–±–æ—Ç—ã –≤ —Å–ª–æ–º–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏"
   */
  process.on('uncaughtException', (error) => {
    const isCI = process.env['CI'] === 'true';

    console.error('üíÄ CRITICAL: Uncaught exception in test environment');
    console.error('Error:', error.message);
    console.error('Stack:', error.stack);

    if (isCI) {
      // –í CI: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–±–æ—Ä–∫–∏
      console.error('CI mode: Terminating immediately');
      process.exit(1);
    } else {
      // –í dev: –¥–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ —á—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤, –∑–∞—Ç–µ–º –∑–∞–≤–µ—Ä—à–∞–µ–º
      console.error('Dev mode: Terminating in 2 seconds...');
      setTimeout(() => {
        console.error('Dev mode: Forced termination');
        process.exit(1);
      }, 2000);
    }
  });

  /**
   * –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö —Ç–∞–π–º–∞—É—Ç–æ–≤
   * –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ CI
   * –í dev: 15 –º–∏–Ω—É—Ç (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –¥–æ–ª–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤)
   * –í CI: 5 –º–∏–Ω—É—Ç (–±—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º)
   */
  const isCI = process.env['CI'] === 'true';
  const GLOBAL_TIMEOUT = isCI
    ? 5 * 60 * 1000 // 5 –º–∏–Ω—É—Ç –≤ CI
    : 15 * 60 * 1000; // 15 –º–∏–Ω—É—Ç –≤ dev

  setTimeout(() => {
    console.error(
      `üíÄ GLOBAL TEST TIMEOUT: Tests running too long (${GLOBAL_TIMEOUT / 60000}min), terminating`,
    );
    console.error('Hint: Increase timeout with VITEST_GLOBAL_TIMEOUT_MS env var');
    process.exit(1);
  }, GLOBAL_TIMEOUT);

  // –ù–µ –æ—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç - –ø—É—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø—É—Ç—ë–º
  // –∏–ª–∏ –±—É–¥–µ—Ç —É–±–∏—Ç –ø–æ —Ç–∞–π–º–∞—É—Ç—É –µ—Å–ª–∏ –∑–∞–≤–∏—Å
})();

// ------------------ –ß–ò–°–¢–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –ú–ï–ñ–î–£ –¢–ï–°–¢–ê–ú–ò -----------------------------

/**
 * –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
 * –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —á–∏—Å—Ç–æ—Ç—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –ª–æ–≥–∏–∫—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 */
afterEach(async () => {
  // –û—á–∏—Å—Ç–∫–∞ fake timers –µ—Å–ª–∏ –æ–Ω–∏ –∞–∫—Ç–∏–≤–Ω—ã
  if (vi.isFakeTimers()) {
    await vi.runAllTimersAsync();
  }

  // –î–∞—ë–º event loop –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
  // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º waitFor(() => true) - —ç—Ç–æ –º–∞–≥–∏—è –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
  await new Promise((resolve) => setImmediate(resolve));
});
